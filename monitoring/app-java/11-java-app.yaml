apiVersion: v1
kind: ConfigMap
metadata:
  name: java-app-source
  namespace: monitoring
data:
  App.java: |
    import java.sql.Connection;
    import java.sql.DriverManager;
    import java.sql.PreparedStatement;
    import java.sql.ResultSet;
    import java.sql.Statement;
    import java.time.LocalDateTime;
    import java.time.format.DateTimeFormatter;
    import java.util.Random;
    import java.util.concurrent.TimeUnit;
    
    import io.opentelemetry.api.trace.Span;

    public class App {
        public static void main(String[] args) {
            System.out.println("Starting Java Query Tester...");
            String urlWithoutDb = "jdbc:mysql://mysql.db.svc:3306/?useSSL=false&allowPublicKeyRetrieval=true";
            String urlWithDb = "jdbc:mysql://mysql.db.svc:3306/testdb?useSSL=false&allowPublicKeyRetrieval=true";
            String user = "root";
            String password = "rootpassword123!";
            Random random = new Random();

            try {
                Class.forName("com.mysql.cj.jdbc.Driver");
                
                try (Connection conn = DriverManager.getConnection(urlWithoutDb, user, password)) {
                    try (Statement stmt = conn.createStatement()) {
                        stmt.execute("CREATE DATABASE IF NOT EXISTS testdb");
                        stmt.execute("USE testdb");
                        stmt.execute("CREATE TABLE IF NOT EXISTS logs (id INT AUTO_INCREMENT PRIMARY KEY, message VARCHAR(255))");
                    }
                }

                while (true) {
                    try (Connection conn = DriverManager.getConnection(urlWithDb, user, password)) {
                        
                        // INSERT (PreparedStatement)
                        String insertQuery = "INSERT INTO logs (message) VALUES (?)";
                        try (PreparedStatement pstmt = conn.prepareStatement(insertQuery)) {
                            String msg = "Log entry " + random.nextInt(1000);
                            pstmt.setString(1, msg);
                            
                            // [Manual Instrumentation] Capture full SQL with values
                            // MySQL driver's toString() returns: "com.mysql.cj.jdbc.ClientPreparedStatement: INSERT ... VALUES ('...'))"
                            String fullSql = pstmt.toString();
                            int sqlIndex = fullSql.indexOf(": ");
                            if (sqlIndex > 0) {
                                fullSql = fullSql.substring(sqlIndex + 2);
                            }
                            // Overwrite db.statement attribute
                            Span.current().setAttribute("db.statement", fullSql);
                            
                            pstmt.executeUpdate();
                        }

                        // SELECT (Statement)
                        // Statement usually contains literals directly, but let's capture it explicitly too if needed.
                        String selectQuery = "SELECT * FROM logs ORDER BY id DESC LIMIT 1";
                        try (Statement stmt = conn.createStatement()) {
                            // For standard Statement, the query string itself is the full SQL
                            Span.current().setAttribute("db.statement", selectQuery);
                            
                            try (ResultSet rs = stmt.executeQuery(selectQuery)) {
                                if (rs.next()) {
                                    String msg = rs.getString("message");
                                }
                            }
                        }
                        
                        String traceId = Span.current().getSpanContext().getTraceId();
                        String ts = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss.SSS"));
                        System.out.printf("%s [ INFO] %d --- [main] App:Executed queries traceId: %s%n", ts, ProcessHandle.current().pid(), traceId);
                        
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                    
                    TimeUnit.SECONDS.sleep(2);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: java-query-tester
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: java-query-tester
  template:
    metadata:
      labels:
        app: java-query-tester
    spec:
      initContainers:
      - name: download-libs
        image: busybox
        command: ["sh", "-c"]
        args:
        - |
          wget -O /libs/opentelemetry-javaagent.jar https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.32.1/opentelemetry-javaagent.jar
          wget -O /libs/mysql-connector-j.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.2.0/mysql-connector-j-8.2.0.jar
          wget -O /libs/opentelemetry-api.jar https://repo1.maven.org/maven2/io/opentelemetry/opentelemetry-api/1.34.1/opentelemetry-api-1.34.1.jar
          wget -O /libs/opentelemetry-context.jar https://repo1.maven.org/maven2/io/opentelemetry/opentelemetry-context/1.34.1/opentelemetry-context-1.34.1.jar
        volumeMounts:
        - name: libs
          mountPath: /libs
      containers:
      - name: java-app
        image: eclipse-temurin:17-jdk
        command: ["/bin/sh", "-c"]
        args:
        - |
          javac -cp /libs/opentelemetry-api.jar:/libs/opentelemetry-context.jar /app/App.java -d /app
          
          # Ensure opentelemetry-api is in the classpath at runtime so App can call Span.current()
          java -javaagent:/libs/opentelemetry-javaagent.jar \
               -cp /app:/libs/mysql-connector-j.jar:/libs/opentelemetry-api.jar:/libs/opentelemetry-context.jar \
               App
        env:
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_METRICS_EXPORTER
          value: "none"
        - name: OTEL_LOGS_EXPORTER
          value: "none"
        - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: "http://tempo.monitoring.svc:4318/v1/traces"
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          value: "http/protobuf"
        - name: OTEL_SERVICE_NAME
          value: "java-query-tester"
        - name: OTEL_INSTRUMENTATION_JDBC_STATEMENT_SANITIZER_ENABLED
          value: "false"
        - name: OTEL_INSTRUMENTATION_COMMON_DB_STATEMENT_SANITIZER_ENABLED
          value: "false"
        volumeMounts:
        - name: source
          mountPath: /app/App.java
          subPath: App.java
        - name: libs
          mountPath: /libs
        - name: app-bin
          mountPath: /app
      volumes:
      - name: source
        configMap:
          name: java-app-source
      - name: libs
        emptyDir: {}
      - name: app-bin
        emptyDir: {}