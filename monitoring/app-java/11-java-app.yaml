apiVersion: v1
kind: ConfigMap
metadata:
  name: java-app-source
  namespace: monitoring
data:
  App.java: |
    import java.sql.Connection;
    import java.sql.DriverManager;
    import java.sql.PreparedStatement;
    import java.sql.ResultSet;
    import java.sql.Statement;
    import java.time.LocalDateTime;
    import java.time.format.DateTimeFormatter;
    import java.util.Random;
    import java.util.concurrent.TimeUnit;
    
    // OpenTelemetry API (Agent가 클래스패스에 주입해줌, 컴파일 위해 필요할 수 있으나 
    // 여기서는 Agent 방식이므로 런타임에 해결되거나, 단순 로깅용 traceId는 MDC나 직접 파싱해야 함.
    // 하지만 컴파일 타임 의존성 없이 Agent만으로는 코드 내에서 traceId를 가져오기 어렵습니다.
    // 따라서 여기서는 간편하게 'System.out' 로그에 traceId를 찍기 위해 
    // OTEL API jar도 같이 다운로드해서 컴파일 시 사용하거나, 
    // Agent가 로그 포맷을 자동으로 주입(Log Injection)하도록 설정하는 것이 좋습니다.
    // 여기서는 가장 확실한 방법으로 OTEL API를 사용하여 TraceID를 가져옵니다.
    
    import io.opentelemetry.api.trace.Span;

    public class App {
        public static void main(String[] args) {
            System.out.println("Starting Java Query Tester...");
            String url = "jdbc:mysql://mysql.db.svc:3306/testdb?useSSL=false&allowPublicKeyRetrieval=true";
            String user = "root";
            String password = "rootpassword123!";
            Random random = new Random();

            try {
                // 1. DB 연결 및 테이블 생성
                Class.forName("com.mysql.cj.jdbc.Driver");
                try (Connection conn = DriverManager.getConnection(url, user, password)) {
                    try (Statement stmt = conn.createStatement()) {
                        stmt.execute("CREATE DATABASE IF NOT EXISTS testdb");
                        stmt.execute("USE testdb");
                        stmt.execute("CREATE TABLE IF NOT EXISTS logs (id INT AUTO_INCREMENT PRIMARY KEY, message VARCHAR(255))");
                    }
                }

                // 2. 반복 루프
                while (true) {
                    try (Connection conn = DriverManager.getConnection(url, user, password)) {
                        conn.setCatalog("testdb");
                        
                        // INSERT
                        String insertQuery = "INSERT INTO logs (message) VALUES (?)";
                        try (PreparedStatement pstmt = conn.prepareStatement(insertQuery)) {
                            pstmt.setString(1, "Log entry " + random.nextInt(1000));
                            pstmt.executeUpdate();
                        }

                        // SELECT
                        String selectQuery = "SELECT * FROM logs ORDER BY id DESC LIMIT 1";
                        try (Statement stmt = conn.createStatement();
                             ResultSet rs = stmt.executeQuery(selectQuery)) {
                            if (rs.next()) {
                                String msg = rs.getString("message");
                            }
                        }
                        
                        // Log with TraceID
                        String traceId = Span.current().getSpanContext().getTraceId();
                        String ts = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss.SSS"));
                        System.out.printf("%s [ INFO] %d --- [main] App:Executed queries traceId: %s%n", ts, ProcessHandle.current().pid(), traceId);
                        
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                    
                    TimeUnit.SECONDS.sleep(2);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: java-query-tester
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: java-query-tester
  template:
    metadata:
      labels:
        app: java-query-tester
    spec:
      initContainers:
      - name: download-libs
        image: busybox
        command: ["sh", "-c"]
        args:
        - |
          wget -O /libs/opentelemetry-javaagent.jar https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.32.1/opentelemetry-javaagent.jar
          wget -O /libs/mysql-connector-j.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.2.0/mysql-connector-j-8.2.0.jar
          wget -O /libs/opentelemetry-api.jar https://repo1.maven.org/maven2/io/opentelemetry/opentelemetry-api/1.34.1/opentelemetry-api-1.34.1.jar
          wget -O /libs/opentelemetry-context.jar https://repo1.maven.org/maven2/io/opentelemetry/opentelemetry-context/1.34.1/opentelemetry-context-1.34.1.jar
        volumeMounts:
        - name: libs
          mountPath: /libs
      containers:
      - name: java-app
        image: openjdk:17-jdk-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Compile (Classpath: OTEL API + MySQL Driver)
          javac -cp /libs/opentelemetry-api.jar:/libs/opentelemetry-context.jar /app/App.java -d /app
          
          # Run (Agent + Classpath)
          # OTEL_TRACES_EXPORTER=otlp (Send to Tempo)
          # OTEL_INSTRUMENTATION_JDBC_STATEMENT_SANITIZER_ENABLED=false (Show full query)
          java -javaagent:/libs/opentelemetry-javaagent.jar \
               -cp /app:/libs/mysql-connector-j.jar:/libs/opentelemetry-api.jar:/libs/opentelemetry-context.jar \
               App
        env:
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://tempo.monitoring.svc:4318"
        - name: OTEL_SERVICE_NAME
          value: "java-query-tester"
        - name: OTEL_INSTRUMENTATION_JDBC_STATEMENT_SANITIZER_ENABLED
          value: "false"
        volumeMounts:
        - name: source
          mountPath: /app/App.java
          subPath: App.java
        - name: libs
          mountPath: /libs
        - name: app-bin
          mountPath: /app
      volumes:
      - name: source
        configMap:
          name: java-app-source
      - name: libs
        emptyDir: {}
      - name: app-bin
        emptyDir: {}
